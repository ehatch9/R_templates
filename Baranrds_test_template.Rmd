---
title: "Barnard's test template"
author: "Emily Hatch"
date: "2023-08-22"
output: 
  html_document:
   keep_md: TRUE

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = TRUE, warning = FALSE, message = FALSE, error = FALSE, fig_width = 4, fig_height = 6, fig_retina = TRUE, dev = c("png", "pdf")) 
```

#### Objective
Add the results of Barnardâ€™s test to a dataframe in R

#### Pseudocode
load the necessary libraries
create a dataframe
identify the control values for comparison
use rowwise() and mutate() to create a column for the results
format to call the correct results barnard.test()$p.value[2]
Note that this will call the two-sided p-value, if you would like to switch to a 1-sided test you can change it to say barnard.test()$p.value[1]

```{r dependencies}
library(Barnard)
library(tidyverse)

categories <- data.frame(condition = c('DMSO', 'BLEB', 'B5', 'B6', 'B7_2uM', 'B8', 'D9', 'B7_500nM'), 
     NOTRUP = c(155, 155, 122, 163, 175, 211, 130, 168),
     RUP = c(55, 28, 38, 47, 46, 40, 58, 38))

ctrl <- categories %>% filter(grepl('DMSO', condition))

NEGctrl <- ctrl$NOTRUP
POSctrl <- ctrl$RUP

stats <- categories %>%
     rowwise() %>%
     mutate('p' = barnard.test(NEGctrl, NOTRUP, POSctrl, RUP)$p.value[2]
          ) %>%
     mutate('significant' = case_when(
          p <= 0.05 ~ '*'))
```

I also added a column that automatically adds a star to data that is significant so you could add this to a graph easily using

geom_text(data = stats, aes(x = condition, y = 0.6, label = paste(significant)))

Note that for a large table this is going to take a good chunk of time to run, so you may need to be a bit patient.

#### Alternative method for pairwise Barnard's test.
This uses a package from the Fred Hutch Vaccine Immunology Statistical Center. 

Input: two vectors, x with 0/1, or logical vector, or T/F  (for us, equivalent of y/n) and y, which is the categories. Sums up the frequencies, but it's hard to get that out of the resulting data frame, and performs Barnards. There is not a correction, I think, for multiple hypothesis testing. See example for extracting vectors from a grouped dataframe.  https://rdrr.io/github/FredHutch/VISCfunctions/man/pairwise_test_bin.html

```{r}
install.packages("remotes")
remotes::install_github("FredHutch/VISCfunctions", build_vignettes = TRUE)
vignette("Overview")
library(VISCfunctions)

#Vignette test. Dplyr example
data(exampleData_BAMA)

group_testing <- exampleData_BAMA %>%
   group_by(antigen, visitno) %>%
   group_modify(~ as.data.frame(
       pairwise_test_bin(x = .$response, group = .$group,
               method = 'barnard', alternative = 'less',
               num_needed_for_test = 3, digits = 1,
               trailing_zeros = TRUE, sep_val = ' vs. ', verbose = TRUE)))
group_testing
```


```{r}
# Base R example
set.seed(1)
x_example = c(NA,sample(0:1,50,replace = TRUE, prob = c(.75,.25)),
  sample(0:1,50,replace = TRUE, prob = c(.25,.75)),0,0,1,1)
group_example = c(rep(1,25),NA,rep(2,25),rep(3,25),rep(4,25),'a','a','b','b')

test <- pairwise_test_bin(
x_example,group_example,
  sorted_group = c(1:4, 'a','b'),num_needed_for_test = 2)

test
```

